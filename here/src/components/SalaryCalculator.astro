---
---
<style>
  .calc { border:1px solid #e6e6e6; padding:1rem; border-radius:8px; background:#fafafa; }
  .row { display:flex; gap:1rem; align-items:center; margin:0.5rem 0; }
  label { min-width:140px; color:#333; }
  input[type="number"] { padding:6px 8px; width:200px; }
  button { padding:8px 12px; cursor:pointer; }
  .result { margin-top:1rem; background:#fff; padding:0.75rem; border-radius:6px; border:1px solid #eee; }
  .line { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #f0f0f0; }
  .muted { color:#666; font-size:0.9rem; margin-top:0.5rem; }
</style>

<div class="calc" id="salary-calculator">
  <div class="row">
    <label for="ral"> Inserisci RAL (â‚¬/anno)</label>
    <input id="ral" type="number" min="0" step="100" value="35000" />
    <button id="calcBtn">Calcola</button>
    <button id="downloadPdfBtn" disabled>Scarica PDF</button>
  </div>

  <div id="results" class="result" aria-live="polite" hidden>
    <!-- risultati popolati da JS -->
  </div>

  <div class="muted">
    Nota: prototipo semplificato. Le percentuali usate sono d'esempio e non sostituiscono consulenza fiscale.
  </div>
</div>

<script type="module">
  const el = document.getElementById('salary-calculator');
  const ralInput = el.querySelector('#ral');
  const btn = el.querySelector('#calcBtn');
  const downloadBtn = el.querySelector('#downloadPdfBtn');
  const results = el.querySelector('#results');

  function fmt(v) {
    return v.toLocaleString('it-IT', { style:'currency', currency:'EUR' });
  }

  // Calcolo IRPEF progressiva semplificata
  function computeIrpef(taxable) {
    const brackets = [
      { upTo: 28000, rate: 0.23 },
      { upTo: 50000, rate: 0.35 },
      { upTo: Infinity, rate: 0.43 },
    ];
    let remaining = taxable;
    let tax = 0;
    let lower = 0;
    for (const b of brackets) {
      const top = b.upTo;
      const slice = Math.max(0, Math.min(remaining, top - lower));
      tax += slice * b.rate;
      remaining -= slice;
      lower = top;
      if (remaining <= 0) break;
    }
    return Math.max(0, tax);
  }

  function calculate(ral) {
    // Parametri semplificati
    const inpsRate = 0.0949;           // contributi a carico del dipendente (esempio)
    const regionalRate = 0.0123;      // addizionale regionale (esempio)
    const municipalRate = 0.005;      // addizionale comunale (esempio)

    const inps = ral * inpsRate;
    const taxable = Math.max(0, ral - inps); // reddito imponibile IRPEF semplificato
    const irpef = computeIrpef(taxable);
    const regional = taxable * regionalRate;
    const municipal = taxable * municipalRate;

    const netAnnual = ral - inps - irpef - regional - municipal;
    const netMonthly = netAnnual / 12;

    const effectiveTax = ((ral - netAnnual) / ral) || 0;

    return {
      ral, inps, taxable, irpef, regional, municipal, netAnnual, netMonthly, effectiveTax
    };
  }

  function render(resObj) {
    results.hidden = false;
    results.innerHTML = `
      <div class="line"><strong>RAL lorda</strong><span>${fmt(resObj.ral)}</span></div>
      <div class="line"><span>Contributi INPS (dipendente 9.49%)</span><span>${fmt(resObj.inps)}</span></div>
      <div class="line"><span>Reddito imponibile (RAL - INPS)</span><span>${fmt(resObj.taxable)}</span></div>
      <div class="line"><span>IRPEF (progressivo)</span><span>${fmt(resObj.irpef)}</span></div>
      <div class="line"><span>Addiz. regionale (1.23%)</span><span>${fmt(resObj.regional)}</span></div>
      <div class="line"><span>Addiz. comunale (0.50%)</span><span>${fmt(resObj.municipal)}</span></div>
      <div class="line" style="font-weight:700"><strong>Netto annuo stimato</strong><strong>${fmt(resObj.netAnnual)}</strong></div>
      <div class="line" style="font-weight:700"><strong>Netto mensile stimato</strong><strong>${fmt(resObj.netMonthly)}</strong></div>
      <div class="muted">Imposta/Trattenute totali: ${ (resObj.effectiveTax*100).toFixed(2) }% della RAL</div>
    `;
    if (downloadBtn) downloadBtn.disabled = false;
  }

  btn.addEventListener('click', () => {
    const ral = parseFloat(ralInput.value || 0);
    const res = calculate(ral);
    render(res);
  });

  // carica dinamicamente html2pdf.js (bundle) da CDN
  function loadHtml2Pdf() {
    return new Promise((resolve, reject) => {
      if (window.html2pdf) return resolve(window.html2pdf);
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js';
      s.async = true;
      s.onload = () => resolve(window.html2pdf);
      s.onerror = () => reject(new Error('Impossibile caricare html2pdf.js'));
      document.head.appendChild(s);
    });
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      try {
        await loadHtml2Pdf();
        const ral = parseFloat(ralInput.value || 0);
        const filename = `salary-${(isNaN(ral) ? 'calc' : ral)}.pdf`;
        // genera PDF a partire dall'elemento dei risultati
        html2pdf().set({
          margin: 10,
          filename,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(results).save();
      } catch (err) {
        console.error('Errore generazione PDF', err);
        alert('Errore durante la generazione del PDF. Riprova.');
      }
    });
  }

  // calcola al caricamento con valore di default
  btn.click();
  </script>